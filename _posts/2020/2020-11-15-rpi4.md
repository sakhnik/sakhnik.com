---
layout: post
title:  "Harnessing Raspberry Pi 4 Model B with 8GB RAM"
ref:    2020-11-15-rpi4
lang:   en
date:   2020-11-15 21:56:13 +02:00
tags:   linux raspberrypi
---

I've been using LGE webOS smart TV since 2014. It has been working seemingly
well. Except for some nuissances like inability to play
[Classic FM](https://www.classicfm.com).
Raspberry Pi 4 with 8 GB RAM seems a good choice for a smart TV set-top box.
But here is the issue: hardware accelerated video decoding only works
in a 32-bit OS that can only operate 4GB RAM at most. It's more than just trading
precious RAM for CPU cycles, videos don't play smoothly at all.

So here is how I set it up with very little to no compromise:

- Install `aarch64` [Manjaro](https://www.manjaro.org/downloads/arm/raspberry-pi-4/arm8-raspberry-pi-4-xfce/)
- Setup a 32-bit raspios container to run hardware-accelerated VLC, as well as
other Raspberry Pi goodies like Wolfram Mathematica
- Create a couple of bash scripts to simplify launching contained applications.

While it's trivial to download and boot the Manjaro image, let me describe
how to run raspios in more detail.

First we need to download an image and extract
its root file system into `/var/lib/machines/raspios`. The partition table doesn't
allow using `losetup`. So some manual calculation will be necessary using the following commands:
```
fdisk -l
mount -v -o loop,offset=$((512*start2)) -t ext4 raspios.img /mnt
mount -v -o loop,offset=$((512*start1)),sizelimit=$((512*size1)) -t vfat raspios.img /tmp
```
Then the files could be just copied over the desired location:
```
sudo rsync -raP /mnt/* /var/lib/machines/raspios/
```

Then the following configuration files for systemd-nspawn need be created as recorded
in the repository [sakhnik/chbox](https://github.com/sakhnik/chbox/tree/rpi4/host):
```
./etc/polkit-1/rules.d/49-nopasswd_limited.rules
./etc/systemd/nspawn/raspios.nspawn
./etc/systemd/system/systemd-nspawn@raspios.service.d/override.conf
```

The machine could be started at this point with `machinectl start raspios`. The startup may take a bit of time because of `dhcpcd`. It can be profiled and improved later with `systemd-analyze blame`.